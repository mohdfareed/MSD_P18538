@page "/transcription"
@inject Services.TranscriptionService TranscriptionService
@using MudBlazor

<PageTitle>Transcription</PageTitle>
<MudText Typo="Typo.h3" Class="mb-3">Live Transcription</MudText>
<MudCard>
    <MudCardContent Style="display: flex; flex-direction: column-reverse; height: 300px; overflow-y: scroll;">
        <MudText Typo="Typo.h4">@(string.Join(' ', transcriptions))</MudText>
    </MudCardContent>
    <MudCardActions>
        @if (isTranscribing)
        {
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Adjust" Color="Color.Success"
                OnClick="@(transcriptionCancellationTokenSource.Cancel)">Transcribing...</MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Adjust" Color="Color.Error"
                OnClick="@(async () => await StartTranscription())">Not transcribing</MudButton>
        }
        @if (isRecording)
        {
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Mic" Color="Color.Warning"
                OnClick="@(recordingCancellationTokenSource.Cancel)">Recording...</MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Mic" Color="Color.Error"
                OnClick="@(async () => await StartRecording())">Not recording</MudButton>
        }
    </MudCardActions>
</MudCard>



@code {
    private List<string> transcriptions = new List<string> { "" };
    private bool isTranscribing = false;
    private bool isRecording = false;
    private CancellationTokenSource transcriptionCancellationTokenSource = new CancellationTokenSource();
    private CancellationTokenSource recordingCancellationTokenSource = new CancellationTokenSource();

    private async Task StartTranscription()
    {
        isTranscribing = true;
        transcriptionCancellationTokenSource.Cancel();
        transcriptionCancellationTokenSource = new CancellationTokenSource();
        transcriptionCancellationTokenSource.Token.Register(() => { isTranscribing = false; StateHasChanged(); });
        var transcriber = TranscriptionService.ReceiveTextStreamAsync(transcriptionCancellationTokenSource.Token);
        await foreach (var text in transcriber)
        {
            OnTranscriptionReceived(text);
        }
        transcriptionCancellationTokenSource.Cancel();
    }

    public async Task StartRecording()
    {
        isRecording = true;
        recordingCancellationTokenSource.Cancel();
        recordingCancellationTokenSource = new CancellationTokenSource();
        recordingCancellationTokenSource.Token.Register(() => { isRecording = false; StateHasChanged(); });
        await TranscriptionService.StartAudioStreamingAsync(recordingCancellationTokenSource.Cancel,
        recordingCancellationTokenSource.Token);
    }


    private void OnTranscriptionReceived(string text)
    {
        // check if a new phrase is starting
        if (string.IsNullOrWhiteSpace(text) && !string.IsNullOrWhiteSpace(transcriptions[^1]))
        {
            transcriptions.Add(""); // Add new line
            if (transcriptions.Count > 1000)
            {
                transcriptions.RemoveAt(0); // Trim oldest line
            }
            return; // Skip adding the empty line
        }
        // update last line with new text
        transcriptions[^1] = text;
        StateHasChanged();
    }
}
